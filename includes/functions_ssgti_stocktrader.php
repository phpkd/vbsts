<?php

// YAHOO FINANCE SPECIAL TAGS #1
define('SSGTI_STOCKTRADER_STAGS1_A',  1);
define('SSGTI_STOCKTRADER_STAGS1_A2', 2);
define('SSGTI_STOCKTRADER_STAGS1_A5', 4);
define('SSGTI_STOCKTRADER_STAGS1_B',  8);
define('SSGTI_STOCKTRADER_STAGS1_B2', 16);
define('SSGTI_STOCKTRADER_STAGS1_B3', 32);
define('SSGTI_STOCKTRADER_STAGS1_B4', 64);
define('SSGTI_STOCKTRADER_STAGS1_B6', 128);
define('SSGTI_STOCKTRADER_STAGS1_C',  256);
define('SSGTI_STOCKTRADER_STAGS1_C1', 512);
define('SSGTI_STOCKTRADER_STAGS1_C3', 1024);
define('SSGTI_STOCKTRADER_STAGS1_C6', 2048);
define('SSGTI_STOCKTRADER_STAGS1_C8', 4096);
define('SSGTI_STOCKTRADER_STAGS1_D',  8192);
define('SSGTI_STOCKTRADER_STAGS1_D1', 16384);
define('SSGTI_STOCKTRADER_STAGS1_D2', 32768);
define('SSGTI_STOCKTRADER_STAGS1_E',  65536);
define('SSGTI_STOCKTRADER_STAGS1_E1', 131072);
define('SSGTI_STOCKTRADER_STAGS1_E7', 262144);
define('SSGTI_STOCKTRADER_STAGS1_E8', 524288);
define('SSGTI_STOCKTRADER_STAGS1_E9', 1048576);
define('SSGTI_STOCKTRADER_STAGS1_G',  2097152);
define('SSGTI_STOCKTRADER_STAGS1_G1', 4194304);
define('SSGTI_STOCKTRADER_STAGS1_G3', 8388608);
define('SSGTI_STOCKTRADER_STAGS1_G4', 16777216);
define('SSGTI_STOCKTRADER_STAGS1_G5', 33554432);
define('SSGTI_STOCKTRADER_STAGS1_G6', 67108864);
define('SSGTI_STOCKTRADER_STAGS1_H',  134217728);

// YAHOO FINANCE SPECIAL TAGS #2
define('SSGTI_STOCKTRADER_STAGS2_I',  1);
define('SSGTI_STOCKTRADER_STAGS2_I5', 2);
define('SSGTI_STOCKTRADER_STAGS2_J',  4);
define('SSGTI_STOCKTRADER_STAGS2_J1', 8);
define('SSGTI_STOCKTRADER_STAGS2_J3', 16);
define('SSGTI_STOCKTRADER_STAGS2_J4', 32);
define('SSGTI_STOCKTRADER_STAGS2_J5', 64);
define('SSGTI_STOCKTRADER_STAGS2_J6', 128);
define('SSGTI_STOCKTRADER_STAGS2_K',  256);
define('SSGTI_STOCKTRADER_STAGS2_K1', 512);
define('SSGTI_STOCKTRADER_STAGS2_K2', 1024);
define('SSGTI_STOCKTRADER_STAGS2_K3', 2048);
define('SSGTI_STOCKTRADER_STAGS2_K4', 4096);
define('SSGTI_STOCKTRADER_STAGS2_K5', 8192);
define('SSGTI_STOCKTRADER_STAGS2_L',  16384);
define('SSGTI_STOCKTRADER_STAGS2_L1', 32768);
define('SSGTI_STOCKTRADER_STAGS2_L2', 65536);
define('SSGTI_STOCKTRADER_STAGS2_L3', 131072);
define('SSGTI_STOCKTRADER_STAGS2_M',  262144);
define('SSGTI_STOCKTRADER_STAGS2_M2', 524288);
define('SSGTI_STOCKTRADER_STAGS2_M3', 1048576);
define('SSGTI_STOCKTRADER_STAGS2_M4', 2097152);
define('SSGTI_STOCKTRADER_STAGS2_M5', 4194304);
define('SSGTI_STOCKTRADER_STAGS2_M6', 8388608);
define('SSGTI_STOCKTRADER_STAGS2_M7', 16777216);
define('SSGTI_STOCKTRADER_STAGS2_M8', 33554432);
define('SSGTI_STOCKTRADER_STAGS2_N4', 67108864);
define('SSGTI_STOCKTRADER_STAGS2_O',  134217728);

// YAHOO FINANCE SPECIAL TAGS #3
define('SSGTI_STOCKTRADER_STAGS3_P',  1);
define('SSGTI_STOCKTRADER_STAGS3_P1', 2);
define('SSGTI_STOCKTRADER_STAGS3_P2', 4);
define('SSGTI_STOCKTRADER_STAGS3_P5', 8);
define('SSGTI_STOCKTRADER_STAGS3_P6', 16);
define('SSGTI_STOCKTRADER_STAGS3_Q',  32);
define('SSGTI_STOCKTRADER_STAGS3_R',  64);
define('SSGTI_STOCKTRADER_STAGS3_R1', 128);
define('SSGTI_STOCKTRADER_STAGS3_R2', 256);
define('SSGTI_STOCKTRADER_STAGS3_R5', 512);
define('SSGTI_STOCKTRADER_STAGS3_R6', 1024);
define('SSGTI_STOCKTRADER_STAGS3_R7', 2048);
define('SSGTI_STOCKTRADER_STAGS3_S1', 4096);
define('SSGTI_STOCKTRADER_STAGS3_S7', 8192);
define('SSGTI_STOCKTRADER_STAGS3_T1', 16384);
define('SSGTI_STOCKTRADER_STAGS3_T6', 32768);
define('SSGTI_STOCKTRADER_STAGS3_T7', 65536);
define('SSGTI_STOCKTRADER_STAGS3_T8', 131072);
define('SSGTI_STOCKTRADER_STAGS3_V',  262144);
define('SSGTI_STOCKTRADER_STAGS3_V1', 524288);
define('SSGTI_STOCKTRADER_STAGS3_V7', 1048576);
define('SSGTI_STOCKTRADER_STAGS3_W',  2097152);
define('SSGTI_STOCKTRADER_STAGS3_W1', 4194304);
define('SSGTI_STOCKTRADER_STAGS3_W4', 8388608);
define('SSGTI_STOCKTRADER_STAGS3_X',  16777216);
define('SSGTI_STOCKTRADER_STAGS3_Y',  33554432);


// User Stocks Columns
define('SSGTI_STOCKTRADER_USHBITS_SHARES',    1);
define('SSGTI_STOCKTRADER_USHBITS_PDATE',     2);
define('SSGTI_STOCKTRADER_USHBITS_LPURCHASE', 4);
define('SSGTI_STOCKTRADER_USHBITS_PPRICE',    8);
define('SSGTI_STOCKTRADER_USHBITS_CPRICE',    16);
define('SSGTI_STOCKTRADER_USHBITS_GAIN',      32);
define('SSGTI_STOCKTRADER_USHBITS_GAINP',     64);
define('SSGTI_STOCKTRADER_USHBITS_TPPRICE',   128);
define('SSGTI_STOCKTRADER_USHBITS_TCPRICE',   256);
define('SSGTI_STOCKTRADER_USHBITS_TGAIN',     512);


/**
* Returns an array of available "Yahoo Finance Special Tags"
*
* @return	array
*/
function ssgti_stocktrader_stags($all = FALSE)
{
	global $vbulletin;

	if ($all)
	{
		$stags = array('s', 'n', 'a', 'a2', 'a5', 'b', 'b2', 'b3', 'b4', 'b6', 'c', 'c1', 'c3', 'c6', 'c8', 'd', 'd1', 'd2', 'e', 'e1', 'e7', 'e8', 'e9', 'g', 'g1', 'g3', 'g4', 'g5', 'g6', 'h', 'i', 'i5', 'j', 'j1', 'j3', 'j4', 'j5', 'j6', 'k', 'k1', 'k2', 'k3', 'k4', 'k5', 'l', 'l1', 'l2', 'l3', 'm', 'm2', 'm3', 'm4', 'm5', 'm6', 'm7', 'm8', 'n4', 'o', 'p', 'p1', 'p2', 'p5', 'p6', 'q', 'r', 'r1', 'r2', 'r5', 'r6', 'r7', 's1', 's7', 't1', 't6', 't7', 't8', 'v', 'v1', 'v7', 'w', 'w1', 'w4', 'x', 'y');
		return $stags;
	}
	else
	{
		$stags = array('s', 'n');
	}


	// #################### YAHOO FINANCE SPECIAL TAGS #1 ####################
	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_A)
	{
		$stags[] = 'a';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_A2)
	{
		$stags[] = 'a2';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_A5)
	{
		$stags[] = 'a5';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_B)
	{
		$stags[] = 'b';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_B2)
	{
		$stags[] = 'b2';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_B3)
	{
		$stags[] = 'b3';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_B4)
	{
		$stags[] = 'b4';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_B6)
	{
		$stags[] = 'b6';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_C)
	{
		$stags[] = 'c';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_C1)
	{
		$stags[] = 'c1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_C3)
	{
		$stags[] = 'c3';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_C6)
	{
		$stags[] = 'c6';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_C8)
	{
		$stags[] = 'c8';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_D)
	{
		$stags[] = 'd';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_D1)
	{
		$stags[] = 'd1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_D2)
	{
		$stags[] = 'd2';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_E)
	{
		$stags[] = 'e';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_E1)
	{
		$stags[] = 'e1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_E7)
	{
		$stags[] = 'e7';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_E8)
	{
		$stags[] = 'e8';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_E9)
	{
		$stags[] = 'e9';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_G)
	{
		$stags[] = 'g';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_G1)
	{
		$stags[] = 'g1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_G3)
	{
		$stags[] = 'g3';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_G4)
	{
		$stags[] = 'g4';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_G5)
	{
		$stags[] = 'g5';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_G6)
	{
		$stags[] = 'g6';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags1'] & SSGTI_STOCKTRADER_STAGS1_H)
	{
		$stags[] = 'h';
	}


	// #################### YAHOO FINANCE SPECIAL TAGS #2 ####################
	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_I)
	{
		$stags[] = 'i';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_I5)
	{
		$stags[] = 'i5';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_J)
	{
		$stags[] = 'j';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_J1)
	{
		$stags[] = 'j1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_J3)
	{
		$stags[] = 'j3';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_J4)
	{
		$stags[] = 'j4';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_J5)
	{
		$stags[] = 'j5';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_J6)
	{
		$stags[] = 'j6';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_K)
	{
		$stags[] = 'k';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_K1)
	{
		$stags[] = 'k1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_K2)
	{
		$stags[] = 'k2';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_K3)
	{
		$stags[] = 'k3';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_K4)
	{
		$stags[] = 'k4';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_K5)
	{
		$stags[] = 'k5';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_L)
	{
		$stags[] = 'l';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_L1)
	{
		$stags[] = 'l1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_L2)
	{
		$stags[] = 'l2';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_L3)
	{
		$stags[] = 'l3';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_M)
	{
		$stags[] = 'm';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_M2)
	{
		$stags[] = 'm2';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_M3)
	{
		$stags[] = 'm3';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_M4)
	{
		$stags[] = 'm4';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_M5)
	{
		$stags[] = 'm5';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_M6)
	{
		$stags[] = 'm6';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_M7)
	{
		$stags[] = 'm7';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_M8)
	{
		$stags[] = 'm8';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_N)
	{
		$stags[] = 'n';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags2'] & SSGTI_STOCKTRADER_STAGS2_N4)
	{
		$stags[] = 'n4';
	}


	// #################### YAHOO FINANCE SPECIAL TAGS #3 ####################
	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_O)
	{
		$stags[] = 'o';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_P)
	{
		$stags[] = 'p';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_P1)
	{
		$stags[] = 'p1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_P2)
	{
		$stags[] = 'p2';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_P5)
	{
		$stags[] = 'p5';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_P6)
	{
		$stags[] = 'p6';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_Q)
	{
		$stags[] = 'q';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_R)
	{
		$stags[] = 'r';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_R1)
	{
		$stags[] = 'r1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_R2)
	{
		$stags[] = 'r2';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_R5)
	{
		$stags[] = 'r5';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_R6)
	{
		$stags[] = 'r6';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_R7)
	{
		$stags[] = 'r7';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_S1)
	{
		$stags[] = 's1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_S7)
	{
		$stags[] = 's7';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_T1)
	{
		$stags[] = 't1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_T6)
	{
		$stags[] = 't6';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_T7)
	{
		$stags[] = 't7';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_T8)
	{
		$stags[] = 't8';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_V)
	{
		$stags[] = 'v';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_V1)
	{
		$stags[] = 'v1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_V7)
	{
		$stags[] = 'v7';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_W)
	{
		$stags[] = 'w';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_W1)
	{
		$stags[] = 'w1';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_W4)
	{
		$stags[] = 'w4';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_X)
	{
		$stags[] = 'x';
	}

	if ($vbulletin->options['ssgti_stocktrader_stags3'] & SSGTI_STOCKTRADER_STAGS3_Y)
	{
		$stags[] = 'y';
	}


	return $stags;
}



/**
* Returns an array of available Stocks
*
* @return	array
*/
function ssgti_stocktrader_stocks($thisuseronly = TRUE, $cachedonly = FALSE)
{
	global $vbulletin;

	$glstocks = $exstocks = $ugstocks = array();
	if (isset($vbulletin->options['ssgti_stocktrader_stocks']) AND $vbulletin->options['ssgti_stocktrader_stocks'] != '')
	{
		if (strpos($vbulletin->options['ssgti_stocktrader_stocks'], ',') !== FALSE)
		{
			$glstocks = explode(',', strtoupper(trim($vbulletin->options['ssgti_stocktrader_stocks'])));
		}
		else
		{
			$glstocks = explode(' ', strtoupper(trim($vbulletin->options['ssgti_stocktrader_stocks'])));
		}
	}


	if ($existing = $vbulletin->db->query_read("SELECT DISTINCT stockid FROM " . TABLE_PREFIX . "ssgti_stocktrader" . (($thisuseronly) ? " WHERE userid = " . $vbulletin->userinfo['userid'] : "")))
	{
		if ($vbulletin->db->num_rows($existing))
		{
			while ($exstock = $vbulletin->db->fetch_array($existing))
			{
				$exstocks[] = $exstock['stockid'];
			}
		}
	}


	if ($thisuseronly)
	{
		if (isset($vbulletin->usergroupcache[$vbulletin->userinfo['usergroupid']]['ssgtistocktrader_stocks']) AND $vbulletin->usergroupcache[$vbulletin->userinfo['usergroupid']]['ssgtistocktrader_stocks'] != '')
		{
			if (strpos($vbulletin->usergroupcache[$vbulletin->userinfo['usergroupid']]['ssgtistocktrader_stocks'], ',') !== FALSE)
			{
				$ugstocks = array_merge($ugstocks, explode(',', strtoupper(trim($vbulletin->usergroupcache[$vbulletin->userinfo['usergroupid']]['ssgtistocktrader_stocks']))));
			}
			else
			{
				$ugstocks = array_merge($ugstocks, explode(' ', strtoupper(trim($vbulletin->usergroupcache[$vbulletin->userinfo['usergroupid']]['ssgtistocktrader_stocks']))));
			}
		}
	}
	else
	{
		foreach ($vbulletin->usergroupcache AS $usergroupid => $usergroup)
		{
			if (isset($usergroup['ssgtistocktrader_stocks']) AND $usergroup['ssgtistocktrader_stocks'] != '')
			{
				if (strpos($usergroup['ssgtistocktrader_stocks'], ',') !== FALSE)
				{
					$ugstocks = array_merge($ugstocks, explode(',', strtoupper(trim($usergroup['ssgtistocktrader_stocks']))));
				}
				else
				{
					$ugstocks = array_merge($ugstocks, explode(' ', strtoupper(trim($usergroup['ssgtistocktrader_stocks']))));
				}
			}
		}
	}


	$return = array_unique(array_merge($glstocks, $exstocks, $ugstocks));

	if (is_array($return) AND count($return))
	{
		return $return;
	}
	else
	{
		return FALSE;
	}
}


function ssgti_stocktrader_htable($data, $type = 'none')
{
	global $vbulletin, $vbphrase, $stylevar, $bgclass;

	if (!is_array($data) OR count($data) <= 0)
	{
		$colspan = 1;
		$ssgti_stocktrader['norecords'] = TRUE;
		eval('$table = "' . fetch_template('ssgti_stocktrader_htable') . '";');
		return $table;
	}

	$headbits = $rowbits = $cellbits = '';
	$allbits = ssgti_stocktrader_stags();
	foreach ($allbits AS $singlehead)
	{
		if ($singlehead != 'n')
		{
			$headbittitle = $vbphrase['ssgti_stocktrader_stags_' . $singlehead];
			eval('$headbits .= "' . fetch_template('ssgti_stocktrader_htable_headbits') . '";');
		}
	}

	switch ($type)
	{
		case 'buy':
			eval('$headbits .= "' . fetch_template('ssgti_stocktrader_htable_headbuy') . '";');
			break;
		case 'sell':
			eval('$headbits .= "' . fetch_template('ssgti_stocktrader_htable_headsell') . '";');
			break;
	}


	foreach ($data AS $row)
	{
		exec_switch_bg();
		if (isset($row['stags']))
		{
			$singlerow = unserialize($row['stags']);
		}
		else
		{
			$singlerow = $row;
		}


		if (count($singlerow) == count($allbits))
		{
			if (array_key_exists('n', $singlerow))
			{
				$cellbit = $singlerow['n'];
				eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_htable_cellbits2') . '";');
				unset($singlerow['n'], $cellbit);
			}

			foreach ($singlerow AS $cellbitid => $cellbit)
			{
				$cellbittitle = $singlerow['s'] . ' - ' . $vbphrase['ssgti_stocktrader_stags_' . $cellbitid];
				eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_htable_cellbits') . '";');
				unset($cellbittitle);
			}

			switch ($type)
			{
				case 'buy':
					$cellbittitle = $singlerow['s'] . ' - ' . $vbphrase['ssgti_stocktrader_buy'];
					eval('$cellbit = "' . fetch_template('ssgti_stocktrader_htable_cellbuy') . '";');
					eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_htable_cellbits') . '";');
					break;
				case 'sell':
					$cellbittitle = $singlerow['s'] . ' - ' . $vbphrase['ssgti_stocktrader_sell'];
					$cellbit = fetch_template('ssgti_stocktrader_htable_cellsell');
					eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_htable_cellbits') . '";');
					break;
			}
		}

		eval('$rowbits .= "' . fetch_template('ssgti_stocktrader_htable_rowbits') . '";');
		unset($cellbits, $headbittitle, $cellbittitle, $cellbit);
	}


	$colspan = count($allbits) + 1;
	eval('$table = "' . fetch_template('ssgti_stocktrader_htable') . '";');

	return $table;
}


function ssgti_stocktrader_vtable($data, $type = 'none')
{
	global $vbulletin, $vbphrase, $stylevar, $bgclass;

	if (!is_array($data) OR count($data) <= 0)
	{
		$colspan = 1;
		$ssgti_stocktrader['norecords'] = TRUE;
		eval('$table = "' . fetch_template('ssgti_stocktrader_vtable') . '";');
		return $table;
	}


	$headbits = $rowbits = $cellbits = '';
	$allbits = ssgti_stocktrader_stags();


	$rows = array();
	foreach ($data AS $row)
	{
		if (isset($row['stags']))
		{
			$singlerow = unserialize($row['stags']);
		}
		else
		{
			$singlerow = $row;
		}


		if (count($singlerow) == count($allbits))
		{
			if (array_key_exists('n', $singlerow))
			{
				$headbittitle = $singlerow['n'];
				eval('$headbits .= "' . fetch_template('ssgti_stocktrader_vtable_headbits') . '";');
				unset($singlerow['n'], $headbittitle);
			}

			foreach ($singlerow AS $cellbitid => $cellbit)
			{
				$rows["$cellbitid"]["$singlerow[s]"] = $cellbit;
			}

			switch ($type)
			{
				case 'buy':
				case 'sell':
					$rows["$type"]["$singlerow[s]"] = TRUE;
					break;
			}
		}
	}


	if (count($data) % 2)
	{
		exec_switch_bg();
	}


	foreach ($rows AS $rowid => $row)
	{
		if (count($data) % 2)
		{
			exec_switch_bg();
		}

		if (in_array($rowid, array('buy', 'sell')))
		{
			eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_vtable_head' . $rowid) . '";');
		}
		else
		{
			$cellbit = $vbphrase['ssgti_stocktrader_stags_' . $rowid];
			eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_vtable_cellbits2') . '";');
		}

		foreach ($row AS $cellbitid => $cellbit)
		{
			exec_switch_bg();
			if (in_array($rowid, array('buy', 'sell')))
			{
				$cellbittitle = $cellbitid . ' - ' . $vbphrase['ssgti_stocktrader_' . $rowid];
				eval('$cellbit = "' . fetch_template('ssgti_stocktrader_vtable_cell' . $rowid) . '";');
				eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_vtable_cellbits') . '";');
			}
			else
			{
				$cellbittitle = $cellbitid . ' - ' . $vbphrase['ssgti_stocktrader_stags_' . $rowid];
				eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_vtable_cellbits') . '";');
			}

			unset($cellbittitle);
		}

		eval('$rowbits .= "' . fetch_template('ssgti_stocktrader_vtable_rowbits') . '";');
		unset($cellbits);
	}


	$colspan = count($data) + 1;
	eval('$table = "' . fetch_template('ssgti_stocktrader_vtable') . '";');

	return $table;
}


/**
 * Quick Method of building the Nav Template
 *
 * @param	string	The selected item in the Stock Trader Nav
 */
function ssgti_stocktrader_construct_nav($selectedcell = 'home')
{
	global $navclass, $gobutton, $stylevar, $vbphrase, $vbulletin, $template_hook;

	$cells = array(
		'home',
		'invest',
		'stoplossorder',
		'instantinvestorder',
		'purchasehistory',
		'saleshistory',
		'socialgroups',
		'statistics',
		'toplist',
		'spyeye'
	);

	($hook = vBulletinHook::fetch_hook('usercp_nav_start')) ? eval($hook) : false;


	// set the class for each cell/group
	$navclass = array();
	foreach ($cells AS $cellname)
	{
		$navclass["$cellname"] = 'alt2';
	}
	$navclass["$selectedcell"] = 'alt1';
}


function ssgti_stocktrader_ustocks_htable($data, $type = 'none')
{
	global $vbulletin, $vbphrase, $stylevar, $bgclass, $ssgti_stocktrader;

	if (!is_array($data) OR count($data) <= 0)
	{
		$colspan = 1;
		$ssgti_stocktrader['norecords'] = TRUE;
		eval('$table = "' . fetch_template('ssgti_stocktrader_ustocks_htable') . '";');
		return $table;
	}

	$headbits = $rowbits = $cellbits = '';
	$ushbits = ssgti_stocktrader_ustocks_hbits();
	foreach ($ushbits AS $singlehead)
	{
		$headbittitle = $vbphrase['ssgti_stocktrader_ushbits_' . $singlehead];
		eval('$headbits .= "' . fetch_template('ssgti_stocktrader_ustocks_htable_headbits') . '";');
		unset($headbittitle);
	}

	switch ($type)
	{
		case 'buy':
			eval('$headbittitle = "' . fetch_template('ssgti_stocktrader_ustocks_htable_headbuy') . '";');
			eval('$headbits .= "' . fetch_template('ssgti_stocktrader_ustocks_htable_headbits') . '";');
			break;
		case 'sell':
			eval('$headbittitle = "' . fetch_template('ssgti_stocktrader_ustocks_htable_headsell') . '";');
			eval('$headbits .= "' . fetch_template('ssgti_stocktrader_ustocks_htable_headbits') . '";');
			break;
	}


	foreach ($data AS $singlerow)
	{
		exec_switch_bg();


		$cellbittitle = $vbphrase['ssgti_stocktrader_ushbits_stockname'];
		eval('$cellbit = "' . $singlerow['stockname'] . '";');
		eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_ustocks_htable_cellbits2') . '";');

		$cellbittitle = $vbphrase['ssgti_stocktrader_ushbits_stockid'];
		eval('$cellbit = "' . $singlerow['stockid'] . '";');
		eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_ustocks_htable_cellbits') . '";');


		foreach ($ushbits AS $singecellbit)
		{
			if ($singlerow["$singecellbit"])
			{
				$cellbittitle = $singlerow['stockid'] . ' - ' . $vbphrase['ssgti_stocktrader_ushbits_' . $singecellbit];
				$cellbit = $singlerow["$singecellbit"];
				eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_ustocks_htable_cellbits') . '";');
			}
		}

		switch ($type)
		{
			case 'buy':
				$cellbittitle = $vbphrase['ssgti_stocktrader_buy'];
				eval('$cellbit = "' . fetch_template('ssgti_stocktrader_ustocks_htable_cellbuy') . '";');
				eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_htable_cellbits') . '";');
				break;
			case 'sell':
				$cellbittitle = $vbphrase['ssgti_stocktrader_sell'];
				eval('$cellbit = "' . fetch_template('ssgti_stocktrader_ustocks_htable_cellsell') . '";');
				eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_htable_cellbits') . '";');
				break;
		}

		eval('$rowbits .= "' . fetch_template('ssgti_stocktrader_ustocks_htable_rowbits') . '";');
		unset($cellbittitle, $cellbit, $cellbits);
	}


	$colspan = count($ushbits) + 3;
	eval('$table = "' . fetch_template('ssgti_stocktrader_ustocks_htable') . '";');
	unset($headbits, $rowbits);

	return $table;
}


function ssgti_stocktrader_ustocks_vtable($data, $type = 'none')
{
	global $vbulletin, $vbphrase, $stylevar, $bgclass, $ssgti_stocktrader;

	if (!is_array($data) OR count($data) <= 0)
	{
		$colspan = 1;
		$ssgti_stocktrader['norecords'] = TRUE;
		eval('$table = "' . fetch_template('ssgti_stocktrader_ustocks_vtable') . '";');
		return $table;
	}


	$headbits = $rowbits = $cellbits = '';
	// $ushbits = ssgti_stocktrader_ustocks_hbits();


	$rows = array();
	foreach ($data AS $singlerow)
	{
		$headbittitle = $singlerow['stockname'];
		eval('$headbits .= "' . fetch_template('ssgti_stocktrader_ustocks_vtable_headbits') . '";');
		unset($singlerow['stockname']);

		foreach ($singlerow AS $cellbitid => $cellbit)
		{
			$rows["$cellbitid"]["$singlerow[stockid]"] = $cellbit;
		}

		switch ($type)
		{
			case 'buy':
			case 'sell':
				$rows["$type"]["$singlerow[stockid]"] = TRUE;
				break;
		}

		unset($headbittitle);
	}


	foreach ($rows AS $rowid => $row)
	{
		if (in_array($rowid, array('buy', 'sell')))
		{
			eval('$cellbit = "' . fetch_template('ssgti_stocktrader_ustocks_vtable_head' . $rowid) . '";');
			eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_ustocks_vtable_cellbits2') . '";');
		}
		else
		{
			$cellbit = $vbphrase['ssgti_stocktrader_ushbits_' . $rowid];
			eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_ustocks_vtable_cellbits2') . '";');
		}

		foreach ($row AS $cellbitid => $cellbit)
		{
			exec_switch_bg();
			if (in_array($rowid, array('buy', 'sell')))
			{
				$cellbittitle = $cellbitid . ' - ' . $vbphrase['ssgti_stocktrader_' . $rowid];
				eval('$cellbit = "' . fetch_template('ssgti_stocktrader_ustocks_vtable_cell' . $rowid) . '";');
				eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_ustocks_vtable_cellbits') . '";');
			}
			else
			{
				$cellbittitle = $cellbitid . ' - ' . $vbphrase['ssgti_stocktrader_ushbits_' . $rowid];
				eval('$cellbits .= "' . fetch_template('ssgti_stocktrader_ustocks_vtable_cellbits') . '";');
			}

			unset($cellbittitle);
		}

		eval('$rowbits .= "' . fetch_template('ssgti_stocktrader_ustocks_vtable_rowbits') . '";');
		unset($cellbits);
	}


	$colspan = count($data) + 1;
	eval('$table = "' . fetch_template('ssgti_stocktrader_ustocks_vtable') . '";');
	unset($headbits, $cellbits);

	return $table;
}


function ssgti_stocktrader_ustocks_hbits()
{
	global $vbulletin;

	$ushbits = array();


	// #################### User Stocks Columns ####################
	if ($vbulletin->options['ssgti_stocktrader_ushbits'] & SSGTI_STOCKTRADER_USHBITS_SHARES)
	{
		$ushbits[] = 'shares';
	}

	if ($vbulletin->options['ssgti_stocktrader_ushbits'] & SSGTI_STOCKTRADER_USHBITS_PDATE)
	{
		$ushbits[] = 'pdate';
	}

	if ($vbulletin->options['ssgti_stocktrader_ushbits'] & SSGTI_STOCKTRADER_USHBITS_LPURCHASE)
	{
		$ushbits[] = 'lpurchase';
	}

	if ($vbulletin->options['ssgti_stocktrader_ushbits'] & SSGTI_STOCKTRADER_USHBITS_PPRICE)
	{
		$ushbits[] = 'pprice';
	}

	if ($vbulletin->options['ssgti_stocktrader_ushbits'] & SSGTI_STOCKTRADER_USHBITS_TPPRICE)
	{
		$ushbits[] = 'tpprice';
	}

	if ($vbulletin->options['ssgti_stocktrader_ushbits'] & SSGTI_STOCKTRADER_USHBITS_CPRICE)
	{
		$ushbits[] = 'cprice';
	}

	if ($vbulletin->options['ssgti_stocktrader_ushbits'] & SSGTI_STOCKTRADER_USHBITS_TCPRICE)
	{
		$ushbits[] = 'tcprice';
	}

	if ($vbulletin->options['ssgti_stocktrader_ushbits'] & SSGTI_STOCKTRADER_USHBITS_GAIN)
	{
		$ushbits[] = 'gain';
	}

	if ($vbulletin->options['ssgti_stocktrader_ushbits'] & SSGTI_STOCKTRADER_USHBITS_TGAIN)
	{
		$ushbits[] = 'tgain';
	}

	if ($vbulletin->options['ssgti_stocktrader_ushbits'] & SSGTI_STOCKTRADER_USHBITS_GAINP)
	{
		$ushbits[] = 'gainp';
	}


	return $ushbits;
}


function ssgti_stocktrader_currency_symbol($raw)
{
	global $vbulletin, $vbphrase;


	if ($vbulletin->options['ssgti_stocktrader_currency_symbol'])
	{
		switch ($vbulletin->options['ssgti_stocktrader_currency_symbol_pos'])
		{
			case 'before':
				if ($raw < 0)
				{
					$value = construct_phrase($vbphrase['ssgti_stocktrader_points_formatedn1'], vb_number_format(abs($raw), 2), $vbulletin->options['ssgti_stocktrader_currency_symbol']);
				}
				else
				{
					$value = construct_phrase($vbphrase['ssgti_stocktrader_points_formated1'], vb_number_format($raw, 2), $vbulletin->options['ssgti_stocktrader_currency_symbol']);
				}
				break;
			case 'after':
				if ($raw < 0)
				{
					$value = construct_phrase($vbphrase['ssgti_stocktrader_points_formatedn2'], vb_number_format(abs($raw), 2), $vbulletin->options['ssgti_stocktrader_currency_symbol']);
				}
				else
				{
					$value = construct_phrase($vbphrase['ssgti_stocktrader_points_formated2'], vb_number_format($raw, 2), $vbulletin->options['ssgti_stocktrader_currency_symbol']);
				}
				break;
			default:
				if ($raw < 0)
				{
					$value = construct_phrase($vbphrase['ssgti_stocktrader_points_formatedn0'], vb_number_format(abs($raw), 2), $vbulletin->options['ssgti_stocktrader_currency_symbol']);
				}
				else
				{
					$value = construct_phrase($vbphrase['ssgti_stocktrader_points_formated0'], vb_number_format($raw, 2), $vbulletin->options['ssgti_stocktrader_currency_symbol']);
				}
				break;
		}
	}

	return $value;
}


function ssgti_stocktrader_commissions($raw, $type, $status = 'profit')
{
	global $vbulletin, $vbphrase;

	if ($status == 'loss')
	{
		if ($vbulletin->options['ssgti_stocktrader_omitlosscommission'])
		{
			$omitcomm = TRUE;
		}

		if ($vbulletin->options['ssgti_stocktrader_omitlosscgt'])
		{
			$omitcgt = TRUE;
		}
	}


	if ($omitcomm)
	{
		$value = $raw;
	}
	else
	{
		// Commissions
		switch ($type)
		{
			case 'sell':
				$value = $raw - (($raw * $vbulletin->userinfo['permissions']['ssgtistocktrader_comsp']) / 100);
				$value = $value - $vbulletin->userinfo['permissions']['ssgtistocktrader_comsfr'];
				break;
			case 'buy':
				$value = $raw - (($raw * $vbulletin->userinfo['permissions']['ssgtistocktrader_compp']) / 100);
				$value = $value - $vbulletin->userinfo['permissions']['ssgtistocktrader_compfr'];
				break;
		}


		// Check if the final value equal zero or negative after deducting commissions
		if ($value <= 0)
		{
			if ($vbulletin->options['ssgti_stocktrader_negativesaleaction'])
			{
				// Omit Sales Commissions
				$value = $raw;
			}
			else
			{
				// Cancel Transaction
				return FALSE;
			}
		}
	}


	if ($omitcgt)
	{
		$fvalue = $value;
	}
	else
	{
		// Capital Gain Taxes
		switch ($type)
		{
			case 'sell':
				$fvalue = $value - (($value * $vbulletin->userinfo['permissions']['ssgtistocktrader_cgt']) / 100);
				break;
		}


		// Check if the final value equal zero or negative after deducting Capital Gain Taxes
		if ($fvalue <= 0)
		{
			if ($vbulletin->options['ssgti_stocktrader_negativesaleactioncgt'])
			{
				// Omit Capital Gain Taxes
				$fvalue = $value;
			}
			else
			{
				// Cancel Transaction
				return FALSE;
			}
		}
	}


	return round($fvalue, 2);
}


?>